<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>1&nbsp; Data Wrangling Methods – AgroClimate Cookbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./02_weather-data.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-364982630eef5352dd1537128a8ed5cb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script><link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-1.3.1/leaflet.js"></script><link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="site_libs/proj4-2.6.2/proj4.min.js"></script><script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-binding-2.2.3/leaflet.js"></script><script src="site_libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script><script src="site_libs/leaflet-providers-plugin-2.2.3/leaflet-providers-plugin.js"></script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_data-wrangling.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Wrangling Methods</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">AgroClimate Cookbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ucanr-igis/agroclimate-cookbook/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_data-wrangling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Wrangling Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_weather-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Weather Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_simple-agroclim-metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Simple AgroClimate Metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_degday.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Degree Days</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_chill.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Chill</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_agroclimate-rasters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Agroclimate Rasters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_modeled-climate-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Modeled Climate Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_climate-analogues.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">AgroClimate Analogues</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Other Content, Future Work</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="4"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#load-packages" id="toc-load-packages" class="nav-link active" data-scroll-target="#load-packages"><span class="header-section-number">1.1</span> Load packages</a></li>
  <li><a href="#fetch-some-sample-data" id="toc-fetch-some-sample-data" class="nav-link" data-scroll-target="#fetch-some-sample-data"><span class="header-section-number">1.2</span> Fetch Some Sample Data</a></li>
  <li>
<a href="#working-with-date-and-time-data-chloe" id="toc-working-with-date-and-time-data-chloe" class="nav-link" data-scroll-target="#working-with-date-and-time-data-chloe"><span class="header-section-number">1.3</span> Working with Date and Time Data (CHLOE)</a>
  <ul>
<li><a href="#converting-character-date-and-time-columns" id="toc-converting-character-date-and-time-columns" class="nav-link" data-scroll-target="#converting-character-date-and-time-columns"><span class="header-section-number">1.3.1</span> Converting Character Date and Time Columns</a></li>
  <li><a href="#combining-separate-date-and-time-part-columns" id="toc-combining-separate-date-and-time-part-columns" class="nav-link" data-scroll-target="#combining-separate-date-and-time-part-columns"><span class="header-section-number">1.3.2</span> Combining Separate Date and Time Part Columns</a></li>
  <li><a href="#converting-time-zones" id="toc-converting-time-zones" class="nav-link" data-scroll-target="#converting-time-zones"><span class="header-section-number">1.3.3</span> Converting Time Zones</a></li>
  <li><a href="#saving-date-and-time-data-locally" id="toc-saving-date-and-time-data-locally" class="nav-link" data-scroll-target="#saving-date-and-time-data-locally"><span class="header-section-number">1.3.4</span> Saving Date and Time Data Locally</a></li>
  </ul>
</li>
  <li><a href="#units" id="toc-units" class="nav-link" data-scroll-target="#units"><span class="header-section-number">1.4</span> Units</a></li>
  <li><a href="#going-from-long-to-wide" id="toc-going-from-long-to-wide" class="nav-link" data-scroll-target="#going-from-long-to-wide"><span class="header-section-number">1.5</span> Going from Long to Wide</a></li>
  <li><a href="#time-lumping" id="toc-time-lumping" class="nav-link" data-scroll-target="#time-lumping"><span class="header-section-number">1.6</span> Time Lumping</a></li>
  <li><a href="#time-filtering-and-slicing" id="toc-time-filtering-and-slicing" class="nav-link" data-scroll-target="#time-filtering-and-slicing"><span class="header-section-number">1.7</span> Time Filtering and Slicing</a></li>
  <li><a href="#daily-climate-metrics" id="toc-daily-climate-metrics" class="nav-link" data-scroll-target="#daily-climate-metrics"><span class="header-section-number">1.8</span> Daily Climate Metrics</a></li>
  <li><a href="#diurnal-temperature-range" id="toc-diurnal-temperature-range" class="nav-link" data-scroll-target="#diurnal-temperature-range"><span class="header-section-number">1.9</span> Diurnal Temperature Range</a></li>
  <li><a href="#threshhold-based-metrics" id="toc-threshhold-based-metrics" class="nav-link" data-scroll-target="#threshhold-based-metrics"><span class="header-section-number">1.10</span> Threshhold Based Metrics</a></li>
  <li><a href="#counting-consecutive-events" id="toc-counting-consecutive-events" class="nav-link" data-scroll-target="#counting-consecutive-events"><span class="header-section-number">1.11</span> Counting Consecutive Events</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/ucanr-igis/agroclimate-cookbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ucanr-igis/agroclimate-cookbook/edit/main/01_data-wrangling.qmd" class="toc-action"><i class="bi empty"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-data-wrangling" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data Wrangling Methods</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>In this Chapter, we’ll explore some commonly used data wrangling techniques when working with weather data and computing climate metrics.</p>
<section id="load-packages" class="level2" data-number="1.1"><h2 data-number="1.1" class="anchored" data-anchor-id="load-packages">
<span class="header-section-number">1.1</span> Load packages</h2>
<p>The tidyverse provides some generically useful packages for data wrangling.</p>
<p>As usual, start by loading a bunch of packages into memory and specifying our package preferences for conflicting function names:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MOVE THESE BELOW</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ucanr-igis.github.io/caladaptr">caladaptr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/">units</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll be using functions from <code>dplyr</code> quite a bit. Unfortunately some of the functions from <code>dplyr</code> clash with functions with the same name from other packages. For example several packages have a function called <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>.</p>
<p>An easy way to avoid function name clashes is to use the <code>conflicted</code> package to specify your preferences when commonly named functions are called. Typically you do this at the top of your script, so you don’t have to worry about it after that.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://conflicted.r-lib.org/">conflicted</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html">conflict_prefer</a></span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html">conflict_prefer</a></span><span class="op">(</span><span class="st">"count"</span>, <span class="st">"dplyr"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflict_prefer.html">conflict_prefer</a></span><span class="op">(</span><span class="st">"select"</span>, <span class="st">"dplyr"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section><section id="fetch-some-sample-data" class="level2" data-number="1.2"><h2 data-number="1.2" class="anchored" data-anchor-id="fetch-some-sample-data">
<span class="header-section-number">1.2</span> Fetch Some Sample Data</h2>
<p>THIS SECTION WILL EITHER GO OUT ENTIRELY (MOVED TO THE CHAPTER ON IMPORTING CLIMATE DATA), OR BE REPLACED WITH A SIMPLE IMPORT CSV FILE</p>
<p>For the examples in this chapter, we’ll work with late-century daily temperature data for a location near Bakersfield, CA in the southern San Joaquin Valley.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_cap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_loc_pt.html">ca_loc_pt</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">119.151062</span>, <span class="fl">35.261321</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_gcm.html">ca_gcm</a></span><span class="op">(</span><span class="va">gcms</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span>                                 </span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_scenario.html">ca_scenario</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rcp45"</span>, <span class="st">"rcp85"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_period.html">ca_period</a></span><span class="op">(</span><span class="st">"day"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_years.html">ca_years</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fl">2070</span>, end <span class="op">=</span> <span class="fl">2099</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_cvar.html">ca_cvar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tasmin"</span>, <span class="st">"tasmax"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_cap</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_preflight.html">ca_preflight</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>General issues
 - none found
Issues for querying values
 - none found
Issues for downloading rasters
 - none found</code></pre>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">bkrfld_cap</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-179035076cd938b7b516" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-179035076cd938b7b516">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"attributionControl":true},"calls":[{"method":"createMapPane","args":["tmap402",402]},{"method":"addLayersControl","args":[[],"Query Location(s)",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addProviderTiles","args":["OpenStreetMap",null,"OpenStreetMap",{"minZoom":0,"maxZoom":18,"maxNativeZoom":17,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"pane":"tilePane"}]},{"method":"addCircleMarkers","args":[35.261321,-119.151062,1.4,"0000001","Query Location(s)",{"interactive":true,"className":"","pane":"tmap402","stroke":true,"color":"#FF0000","weight":1,"opacity":1,"fill":true,"fillColor":"#999999","fillOpacity":0.8},null,null,"<style> div.leaflet-popup-content {width:auto !important;overflow-y:auto; overflow-x:hidden;}<\/style><div style=\"max-height:25em;padding-right:0px;\"><table>\n\t\t\t   <thead><tr><th colspan=\"2\"><b>0000001<\/b><\/th><\/thead><\/tr><tr><td style=\"color: #888888;\"><nobr>id<\/nobr><\/td><td align=\"right\"><nobr>1<\/nobr><\/td><\/tr><\/table><\/div>",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"fitBounds":[34.741321,-119.671062,35.78132100000001,-118.631062,[]],"limits":{"lat":[35.261321,35.261321],"lng":[-119.151062,-119.151062]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><br></p>
<p>Fetch data:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_cap</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ucanr-igis.github.io/caladaptr/reference/ca_getvals_tbl.html">ca_getvals_tbl</a></span><span class="op">(</span>quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>         temp_f <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">val</span>, <span class="va">degF</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bkrfld_tbl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["cvar"],"name":[2],"type":["fct"],"align":["left"]},{"label":["period"],"name":[3],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[4],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[5],"type":["fct"],"align":["left"]},{"label":["spag"],"name":[6],"type":["fct"],"align":["left"]},{"label":["dt"],"name":[7],"type":["date"],"align":["right"]},{"label":["val"],"name":[8],"type":["units"],"align":["right"]},{"label":["temp_f"],"name":[9],"type":["units"],"align":["right"]}],"data":[{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-01","8":"278.2240 [K]","9":"41.13325 [degF]"},{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-02","8":"277.9093 [K]","9":"40.56680 [degF]"},{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-03","8":"284.1031 [K]","9":"51.71556 [degF]"},{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-04","8":"276.2520 [K]","9":"37.58368 [degF]"},{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-05","8":"280.3573 [K]","9":"44.97308 [degF]"},{"1":"1","2":"tasmin","3":"day","4":"HadGEM2-ES","5":"rcp45","6":"none","7":"2070-01-06","8":"280.1085 [K]","9":"44.52528 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
</section><section id="working-with-date-and-time-data-chloe" class="level2" data-number="1.3"><h2 data-number="1.3" class="anchored" data-anchor-id="working-with-date-and-time-data-chloe">
<span class="header-section-number">1.3</span> Working with Date and Time Data (CHLOE)</h2>
<p>This is really important. As part of importing weather data, you often have to do some wrangling with date and time columns. The goals are to</p>
<ul>
<li><p>Date columns should be converted to R Date class</p></li>
<li><p>Date-time columns should be saved as POSIXct objects</p></li>
</ul>
<section id="converting-character-date-and-time-columns" class="level3" data-number="1.3.1"><h3 data-number="1.3.1" class="anchored" data-anchor-id="converting-character-date-and-time-columns">
<span class="header-section-number">1.3.1</span> Converting Character Date and Time Columns</h3>
<p>Dates and time are often encoded as characters data types. So you have to convert them to R objects. Although this may seem like a pain in the arse, it will save you a lot of pain and suffering.</p>
<p>lubridate is your friend.</p>
<p>Show them all the lubridate functions. (see Lubridate cheatsheet)</p>
</section><section id="combining-separate-date-and-time-part-columns" class="level3" data-number="1.3.2"><h3 data-number="1.3.2" class="anchored" data-anchor-id="combining-separate-date-and-time-part-columns">
<span class="header-section-number">1.3.2</span> Combining Separate Date and Time Part Columns</h3>
<p>Show code here. Concatenate date part fields with <code><a href="https://lubridate.tidyverse.org/reference/make_datetime.html">lubridate::make_date()</a></code> and <code><a href="https://lubridate.tidyverse.org/reference/make_datetime.html">lubridate::make_datetime()</a></code></p>
<p>Could use CIMIS data as an example (which has columns for ‘month’, ‘year’, and ‘day’)</p>
</section><section id="converting-time-zones" class="level3" data-number="1.3.3"><h3 data-number="1.3.3" class="anchored" data-anchor-id="converting-time-zones">
<span class="header-section-number">1.3.3</span> Converting Time Zones</h3>
<p>Pretty common to get datetimes values in UTC.</p>
<p>Note there’s a difference between assigning time zones and converting POSIXct objects to different time zones.</p>
<p>“Pacific Time”, “PST”, “PDT”, etc. are not recognized time zone names. To see a list of recognized time zone values, you can run:</p>
<p>OlsonNames() (there’s also a lubridate function that does the same thing)</p>
<p>lubridate::ymd_hms(x, tz = “America/Los_Angeles”)<br>
## this will</p>
<p>## i) convert x (a character object) to POSIXct. If ‘x’ doesn’t have the time zone represented it will assign the local time zone</p>
<p>## 2) becase we provided tz, it will then convert (add or subtract) the time value to make it Pacific time</p>
<p>## 3) assign Pacific Time to the result</p>
<p>This assigns a time zone, but does not change the value: as.POSIXct(dt, tz=“Africa/Johannesburg”)</p>
</section><section id="saving-date-and-time-data-locally" class="level3" data-number="1.3.4"><h3 data-number="1.3.4" class="anchored" data-anchor-id="saving-date-and-time-data-locally">
<span class="header-section-number">1.3.4</span> Saving Date and Time Data Locally</h3>
<p>If you need to save your weather data to disk, use a format that knows how to save dates and times (e.g., geopackage, native R data file).</p>
<p>If you need to save it in a text format (e.g., csv) or as spreadsheet (e.g., xlsx, Google Sheet), use <code><a href="https://lubridate.tidyverse.org/reference/format_ISO8601.html">lubridate::format_ISO8601()</a></code> to write, and <code><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">lubridate::ymd_hms()</a></code> to bring it back in.</p>
<p><br></p>
</section></section><section id="units" class="level2" data-number="1.4"><h2 data-number="1.4" class="anchored" data-anchor-id="units">
<span class="header-section-number">1.4</span> Units</h2>
<p>Show them the units package</p>
<p>How to convert between F, C, and K</p>
<p><br></p>
</section><section id="going-from-long-to-wide" class="level2" data-number="1.5"><h2 data-number="1.5" class="anchored" data-anchor-id="going-from-long-to-wide">
<span class="header-section-number">1.5</span> Going from Long to Wide</h2>
<p>This is very common. Most tidyverse packages are designed to work with “long” data, but sometimes you have to convert it to wide to feed into another package, compute a metric based on column arithmetic</p>
<p>Use tidyr</p>
<p>Example: CIMIS Data is long, convert to wide</p>
</section><section id="time-lumping" class="level2" data-number="1.6"><h2 data-number="1.6" class="anchored" data-anchor-id="time-lumping">
<span class="header-section-number">1.6</span> Time Lumping</h2>
<p>going from hourly to daily data</p>
</section><section id="time-filtering-and-slicing" class="level2" data-number="1.7"><h2 data-number="1.7" class="anchored" data-anchor-id="time-filtering-and-slicing">
<span class="header-section-number">1.7</span> Time Filtering and Slicing</h2>
<p>changing how we slice and dice time</p>
<p>in both cases, it is useful to construct date parts</p>
<p>Often an analysis requires you to slice climate data into specific periods that are meaningful for a specific study. For example, <a href="https://en.wikipedia.org/wiki/Water_year">water years</a> start on October 1 and run through the following season. Or you might just be interested in the winter months, when tree crops or bugs are particularly sensitive to temperatures. In this section, we’ll look at different techniques for time-slicing climate data.</p>
<p>The general approach is to add a column in the table that identifies the time slice. (If you’re working with rasters, the idea is similar but you add an attribute value to the layer). Once you have the time-slice identifiers in your table, you can easily filter or group on that column to compute summaries for each time-slice.</p>
<p><code>lubridate</code> is your ally when it comes to extracting date parts. For example to add columns for date parts like year, month, week, and ordinal date, we can use the standard <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> with date part functions from lubridate:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_dtprts_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>         month <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>         week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html">week</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>         yday <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">yday</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">week</span>, <span class="va">yday</span>, <span class="va">cvar</span>, <span class="va">gcm</span>, <span class="va">scenario</span>, <span class="va">temp_f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_dtprts_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["week"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["yday"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["cvar"],"name":[6],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[7],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[8],"type":["fct"],"align":["left"]},{"label":["temp_f"],"name":[9],"type":["units"],"align":["right"]}],"data":[{"1":"2070-01-01","2":"2070","3":"1","4":"1","5":"1","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"41.13325 [degF]"},{"1":"2070-01-02","2":"2070","3":"1","4":"1","5":"2","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"40.56680 [degF]"},{"1":"2070-01-03","2":"2070","3":"1","4":"1","5":"3","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"51.71556 [degF]"},{"1":"2070-01-04","2":"2070","3":"1","4":"1","5":"4","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"37.58368 [degF]"},{"1":"2070-01-05","2":"2070","3":"1","4":"1","5":"5","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"44.97308 [degF]"},{"1":"2070-01-06","2":"2070","3":"1","4":"1","5":"6","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"44.52528 [degF]"},{"1":"2070-01-07","2":"2070","3":"1","4":"1","5":"7","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"40.87628 [degF]"},{"1":"2070-01-08","2":"2070","3":"1","4":"2","5":"8","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"47.68594 [degF]"},{"1":"2070-01-09","2":"2070","3":"1","4":"2","5":"9","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"50.53321 [degF]"},{"1":"2070-01-10","2":"2070","3":"1","4":"2","5":"10","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"46.71552 [degF]"},{"1":"2070-01-11","2":"2070","3":"1","4":"2","5":"11","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"39.84467 [degF]"},{"1":"2070-01-12","2":"2070","3":"1","4":"2","5":"12","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"42.90958 [degF]"},{"1":"2070-01-13","2":"2070","3":"1","4":"2","5":"13","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"35.53775 [degF]"},{"1":"2070-01-14","2":"2070","3":"1","4":"2","5":"14","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"34.09942 [degF]"},{"1":"2070-01-15","2":"2070","3":"1","4":"3","5":"15","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"39.41340 [degF]"},{"1":"2070-01-16","2":"2070","3":"1","4":"3","5":"16","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"43.25631 [degF]"},{"1":"2070-01-17","2":"2070","3":"1","4":"3","5":"17","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"44.29935 [degF]"},{"1":"2070-01-18","2":"2070","3":"1","4":"3","5":"18","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"45.52619 [degF]"},{"1":"2070-01-19","2":"2070","3":"1","4":"3","5":"19","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"49.50061 [degF]"},{"1":"2070-01-20","2":"2070","3":"1","4":"3","5":"20","6":"tasmin","7":"HadGEM2-ES","8":"rcp45","9":"44.79362 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<p>To plot the distribution of winter time daily minimum temperatures (i.e., to identify frost days), we could use the month column to get only dates in December, January, and February:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_wintrmth_lows_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_dtprts_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmin"</span>, <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">bkrfld_wintrmth_lows_tbl</span><span class="op">$</span><span class="va">month</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2   12 
7440 6776 7440 </code></pre>
</div>
</div>
<p><br></p>
<p>Plot histogram:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bkrfld_wintrmth_lows_tbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">temp_f</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">scenario</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of Winter Nightime Lows, 2070-2099"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bakersfield, CA"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GCMs: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">gcms</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">". Months: Dec, Jan, and Feb."</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"night time low (F)"</span>, y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01_data-wrangling_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>If we want use the standard definition of the winter season, we could alternately filter winter days by their ordinal date number (aka Julian date). Winter starts on December 21 (day 355 of non-leap years) and ends on March 20 (day 79).</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_wintrssn_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_dtprts_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmin"</span>, <span class="va">yday</span> <span class="op">&gt;=</span> <span class="fl">355</span> <span class="op">|</span> <span class="va">yday</span> <span class="op">&lt;=</span> <span class="fl">79</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bkrfld_wintrssn_tbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">temp_f</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">scenario</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of Winter Nightime Lows, 2070-2099"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bakersfield, CA"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GCMs: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">gcms</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">". December 21 - March 20."</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"night time low (F)"</span>, y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01_data-wrangling_files/figure-html/bkrfld_winter_seasn_tbl-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Time slices can also be used for grouping. The following expression computes the average nightly low for the summer months for each RCP (all GCMs and years combined):</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_dtprts_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">6</span><span class="op">:</span><span class="fl">8</span>, <span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmin"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>avg_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp_f</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="va">month.name</span><span class="op">[</span><span class="va">month</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">month</span>, names_from <span class="op">=</span> <span class="va">scenario</span>, values_from <span class="op">=</span> <span class="va">avg_temp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["month"],"name":[1],"type":["chr"],"align":["left"]},{"label":["rcp45"],"name":[2],"type":["units"],"align":["right"]},{"label":["rcp85"],"name":[3],"type":["units"],"align":["right"]}],"data":[{"1":"June","2":"68.06370 [degF]","3":"71.50234 [degF]"},{"1":"July","2":"74.13334 [degF]","3":"77.97294 [degF]"},{"1":"August","2":"73.82446 [degF]","3":"77.83186 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<p>Sometimes the time period of interest spans two calendar years. A <a href="https://en.wikipedia.org/wiki/Water_year">water year</a> for example starts on October 1 and goes thru the end of September the following year. Some agricultural periods (such as winter dormancy) may also start in the fall and continue into the new year.</p>
<p>Slicing your data by a time period that spans calendar years is done in the same manner - you add a column to the table for period identifier. Below we add a column for water year (which conventionally are designated by the calendar year in which it ends):</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_wtryr_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>water_yr <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">water_yr</span>, <span class="va">cvar</span>, <span class="va">gcm</span>, <span class="va">scenario</span>, <span class="va">temp_f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_wtryr_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["water_yr"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["cvar"],"name":[3],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[4],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[5],"type":["fct"],"align":["left"]},{"label":["temp_f"],"name":[6],"type":["units"],"align":["right"]}],"data":[{"1":"2073-07-29","2":"2073","3":"tasmin","4":"HadGEM2-ES","5":"rcp85","6":"74.60090 [degF]"},{"1":"2094-07-05","2":"2094","3":"tasmin","4":"MIROC5","5":"rcp85","6":"71.41828 [degF]"},{"1":"2087-01-07","2":"2087","3":"tasmin","4":"HadGEM2-ES","5":"rcp45","6":"39.18697 [degF]"},{"1":"2087-08-20","2":"2087","3":"tasmax","4":"MIROC5","5":"rcp85","6":"104.48921 [degF]"},{"1":"2076-01-18","2":"2076","3":"tasmax","4":"CanESM2","5":"rcp45","6":"71.40509 [degF]"},{"1":"2073-04-11","2":"2073","3":"tasmax","4":"CanESM2","5":"rcp85","6":"88.04888 [degF]"},{"1":"2090-12-14","2":"2091","3":"tasmax","4":"HadGEM2-ES","5":"rcp85","6":"64.86537 [degF]"},{"1":"2085-09-24","2":"2085","3":"tasmax","4":"MIROC5","5":"rcp85","6":"101.70456 [degF]"},{"1":"2077-05-08","2":"2077","3":"tasmax","4":"CanESM2","5":"rcp85","6":"96.36438 [degF]"},{"1":"2081-07-24","2":"2081","3":"tasmax","4":"CNRM-CM5","5":"rcp45","6":"108.77525 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
</section><section id="daily-climate-metrics" class="level2" data-number="1.8"><h2 data-number="1.8" class="anchored" data-anchor-id="daily-climate-metrics">
<span class="header-section-number">1.8</span> Daily Climate Metrics</h2>
<p>DELETE THIS</p>
<p>Many climate analyses require metrics computed on a daily time scale. For example, to see how frost exposure might change over time, we may have to look at the lowest daily temperature. This presents a small conundrum, because climate models are not weather forecasts, and best practices tell us that we don’t look at less than 30 years. But it would be silly to average the daily low temperatures by month or year and use that as a proxy for frost exposure.</p>
<p>The general approach in these cases is compute the daily metrics as if you were dealing with observed data, but then to aggregate the metrics over bigger periods of time and space. For example, you could classify each individual day in frost / non-frost, and then count the number of predicted frost days over a 30-year interval.</p>
</section><section id="diurnal-temperature-range" class="level2" data-number="1.9"><h2 data-number="1.9" class="anchored" data-anchor-id="diurnal-temperature-range">
<span class="header-section-number">1.9</span> Diurnal Temperature Range</h2>
<p>DELETE THIS (MOVE TO CHAPTER 3)</p>
<p>Diurnal Temperature Range (DTR) is the difference between daily min and max temperature <span class="citation" data-cites="parker_observed_2022">(<a href="references.html#ref-parker_observed_2022" role="doc-biblioref">Parker et al. 2022</a>)</span>. The magnitude of DTR can impact wine grape development and taste. In the example below, we calculate DTR from November thru February.</p>
<p>The first step is to separate the minimum and maximum daily temperatures into separate columns:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_wide_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>,<span class="fl">12</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">gcm</span>, <span class="va">scenario</span><span class="op">)</span>, names_from <span class="op">=</span> <span class="va">cvar</span>, values_from <span class="op">=</span> <span class="va">temp_f</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bkrfld_wide_tbl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["gcm"],"name":[2],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[3],"type":["fct"],"align":["left"]},{"label":["tasmin"],"name":[4],"type":["units"],"align":["right"]},{"label":["tasmax"],"name":[5],"type":["units"],"align":["right"]}],"data":[{"1":"2070-01-01","2":"HadGEM2-ES","3":"rcp45","4":"41.13325 [degF]","5":"67.24611 [degF]"},{"1":"2070-01-02","2":"HadGEM2-ES","3":"rcp45","4":"40.56680 [degF]","5":"63.24412 [degF]"},{"1":"2070-01-03","2":"HadGEM2-ES","3":"rcp45","4":"51.71556 [degF]","5":"67.03572 [degF]"},{"1":"2070-01-04","2":"HadGEM2-ES","3":"rcp45","4":"37.58368 [degF]","5":"53.86630 [degF]"},{"1":"2070-01-05","2":"HadGEM2-ES","3":"rcp45","4":"44.97308 [degF]","5":"54.82529 [degF]"},{"1":"2070-01-06","2":"HadGEM2-ES","3":"rcp45","4":"44.52528 [degF]","5":"57.94596 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Now we can compute DTR:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_dtr_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_wide_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dtr <span class="op">=</span> <span class="va">tasmax</span> <span class="op">-</span> <span class="va">tasmin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_dtr_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["gcm"],"name":[2],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[3],"type":["fct"],"align":["left"]},{"label":["tasmin"],"name":[4],"type":["units"],"align":["right"]},{"label":["tasmax"],"name":[5],"type":["units"],"align":["right"]},{"label":["dtr"],"name":[6],"type":["units"],"align":["right"]}],"data":[{"1":"2070-01-01","2":"HadGEM2-ES","3":"rcp45","4":"41.13325 [degF]","5":"67.24611 [degF]","6":"26.112854 [degF]"},{"1":"2070-01-02","2":"HadGEM2-ES","3":"rcp45","4":"40.56680 [degF]","5":"63.24412 [degF]","6":"22.677319 [degF]"},{"1":"2070-01-03","2":"HadGEM2-ES","3":"rcp45","4":"51.71556 [degF]","5":"67.03572 [degF]","6":"15.320160 [degF]"},{"1":"2070-01-04","2":"HadGEM2-ES","3":"rcp45","4":"37.58368 [degF]","5":"53.86630 [degF]","6":"16.282617 [degF]"},{"1":"2070-01-05","2":"HadGEM2-ES","3":"rcp45","4":"44.97308 [degF]","5":"54.82529 [degF]","6":"9.852209 [degF]"},{"1":"2070-01-06","2":"HadGEM2-ES","3":"rcp45","4":"44.52528 [degF]","5":"57.94596 [degF]","6":"13.420679 [degF]"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<p>We can show the results with a box plot:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bkrfld_dtr_tbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">scenario</span>, y <span class="op">=</span> <span class="va">dtr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Diurnal Temperature Range, 2070-2099"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bakersfield, CA"</span>, </span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GCMs: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">gcms</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">". Temporal period: Nov-Feb."</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Emission scenarios"</span>, y <span class="op">=</span> <span class="st">"diurnal temperature range"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="01_data-wrangling_files/figure-html/ggplot_bkrfld_dtr_tbl-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
</section><section id="threshhold-based-metrics" class="level2" data-number="1.10"><h2 data-number="1.10" class="anchored" data-anchor-id="threshhold-based-metrics">
<span class="header-section-number">1.10</span> Threshhold Based Metrics</h2>
<p>Many climate analyses involve a threshold event, such as temperature above or below a certain value. These tend to be easy to compute using an expression that returns TRUE or FALSE. Subsequently, you can count the number of threshold events using sum() (when you sum logical values TRUEs become 1 and FALSE becomes 0). You can also look for ‘runs’ of consecutive TRUE values using <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> (see x.x below).</p>
<p>TODO: SIMPLY THE EXAMPLE BELOW, BY USING SAMPLE WEATHER DATA ABOVE (NOT MODELED WEATHER DATA FROM CAL-ADAPT)</p>
<p>Below we compute the number of ‘Hot Days’ per year, where a Hot Day is defined as the maximum temperature over 38 °C (100.4 °F) <span class="citation" data-cites="parker_observed_2022">(<a href="references.html#ref-parker_observed_2022" role="doc-biblioref">Parker et al. 2022</a>)</span>. We need to keep gcm and scenario as we’ll be grouping on those columns next.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_hotday_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmax"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hotday_yn <span class="op">=</span> <span class="va">temp_f</span> <span class="op">&gt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">38</span>, <span class="va">degC</span><span class="op">)</span>,</span>
<span>         year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">year</span>, <span class="va">cvar</span>, <span class="va">scenario</span>, <span class="va">gcm</span>, <span class="va">temp_f</span>, <span class="va">hotday_yn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_hotday_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["cvar"],"name":[3],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[4],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[5],"type":["fct"],"align":["left"]},{"label":["temp_f"],"name":[6],"type":["units"],"align":["right"]},{"label":["hotday_yn"],"name":[7],"type":["lgl"],"align":["right"]}],"data":[{"1":"2070-01-01","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"67.24611 [degF]","7":"FALSE"},{"1":"2070-01-02","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"63.24412 [degF]","7":"FALSE"},{"1":"2070-01-03","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"67.03572 [degF]","7":"FALSE"},{"1":"2070-01-04","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"53.86630 [degF]","7":"FALSE"},{"1":"2070-01-05","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"54.82529 [degF]","7":"FALSE"},{"1":"2070-01-06","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"57.94596 [degF]","7":"FALSE"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<p>Now we can group by year and scenario to compare how the average number of hot days per year looks for each RCP.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numhd_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_hotday_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">scenario</span>, <span class="va">gcm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>num_hotday <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hotday_yn</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year', 'scenario'. You can override using
the `.groups` argument.</code></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numhd_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["scenario"],"name":[2],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[3],"type":["fct"],"align":["left"]},{"label":["num_hotday"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"2070","2":"rcp45","3":"CanESM2","4":"75"},{"1":"2070","2":"rcp45","3":"CNRM-CM5","4":"58"},{"1":"2070","2":"rcp45","3":"HadGEM2-ES","4":"91"},{"1":"2070","2":"rcp45","3":"MIROC5","4":"70"},{"1":"2070","2":"rcp85","3":"CanESM2","4":"88"},{"1":"2070","2":"rcp85","3":"CNRM-CM5","4":"68"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numhd_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>avg_hd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">num_hotday</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">year</span>, names_from <span class="op">=</span> <span class="va">scenario</span>, values_from <span class="op">=</span> <span class="va">avg_hd</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["rcp45"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["rcp85"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"2070","2":"73.50","3":"87.50"},{"1":"2071","2":"73.25","3":"83.00"},{"1":"2072","2":"75.00","3":"83.50"},{"1":"2073","2":"77.50","3":"94.25"},{"1":"2074","2":"83.50","3":"88.50"},{"1":"2075","2":"77.50","3":"79.00"},{"1":"2076","2":"71.00","3":"87.00"},{"1":"2077","2":"65.25","3":"98.25"},{"1":"2078","2":"70.25","3":"94.75"},{"1":"2079","2":"82.00","3":"102.00"},{"1":"2080","2":"73.00","3":"89.50"},{"1":"2081","2":"86.75","3":"96.00"},{"1":"2082","2":"65.50","3":"91.00"},{"1":"2083","2":"77.75","3":"106.50"},{"1":"2084","2":"71.25","3":"94.50"},{"1":"2085","2":"79.75","3":"103.25"},{"1":"2086","2":"86.00","3":"100.00"},{"1":"2087","2":"70.25","3":"105.50"},{"1":"2088","2":"73.75","3":"104.25"},{"1":"2089","2":"64.50","3":"89.75"},{"1":"2090","2":"68.25","3":"103.25"},{"1":"2091","2":"76.75","3":"96.50"},{"1":"2092","2":"80.25","3":"111.00"},{"1":"2093","2":"74.75","3":"105.00"},{"1":"2094","2":"73.25","3":"105.25"},{"1":"2095","2":"83.25","3":"106.50"},{"1":"2096","2":"69.75","3":"105.00"},{"1":"2097","2":"68.75","3":"102.75"},{"1":"2098","2":"81.25","3":"119.00"},{"1":"2099","2":"67.00","3":"107.50"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Sometimes you want to know the number of threshold events during a particular time of the year. For example tree crops are particularly susceptible to frost damage right after they’ve bloomed.</p>
<p>Let’s compute the <strong>number of hot days in June, July and August</strong>, which can be particularly bad for nut development. Because we have daily data from 4 GCMs, we have to count the number of hot days for each GCM, and then average those together for each emissions scenario.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_sumrhd_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmax"</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hd <span class="op">=</span> <span class="va">temp_f</span> <span class="op">&gt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">38</span>, <span class="va">degC</span><span class="op">)</span>,</span>
<span>         year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">year</span>, <span class="va">cvar</span>, <span class="va">scenario</span>, <span class="va">gcm</span>, <span class="va">temp_f</span>, <span class="va">hd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_sumrhd_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["cvar"],"name":[3],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[4],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[5],"type":["fct"],"align":["left"]},{"label":["temp_f"],"name":[6],"type":["units"],"align":["right"]},{"label":["hd"],"name":[7],"type":["lgl"],"align":["right"]}],"data":[{"1":"2070-06-01","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"79.84528 [degF]","7":"FALSE"},{"1":"2070-06-02","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"77.66851 [degF]","7":"FALSE"},{"1":"2070-06-03","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"74.73021 [degF]","7":"FALSE"},{"1":"2070-06-04","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"80.59488 [degF]","7":"FALSE"},{"1":"2070-06-05","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"86.26778 [degF]","7":"FALSE"},{"1":"2070-06-06","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"92.90264 [degF]","7":"FALSE"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numsumrhd_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_sumrhd_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">scenario</span>, <span class="va">gcm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>num_sumrhd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">hd</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">bkrfld_numsumrhd_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["scenario"],"name":[2],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[3],"type":["fct"],"align":["left"]},{"label":["num_sumrhd"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"2070","2":"rcp45","3":"CanESM2","4":"64"},{"1":"2070","2":"rcp45","3":"CNRM-CM5","4":"43"},{"1":"2070","2":"rcp45","3":"HadGEM2-ES","4":"71"},{"1":"2070","2":"rcp45","3":"MIROC5","4":"55"},{"1":"2070","2":"rcp85","3":"CanESM2","4":"69"},{"1":"2070","2":"rcp85","3":"CNRM-CM5","4":"55"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_avgnumsumrhd_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_numsumrhd_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>avg_num_sumrhd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">num_sumrhd</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_avgnumsumrhd_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["scenario"],"name":[2],"type":["fct"],"align":["left"]},{"label":["avg_num_sumrhd"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"2070","2":"rcp45","3":"58.25"},{"1":"2070","2":"rcp85","3":"66.50"},{"1":"2071","2":"rcp45","3":"56.75"},{"1":"2071","2":"rcp85","3":"59.00"},{"1":"2072","2":"rcp45","3":"60.50"},{"1":"2072","2":"rcp85","3":"62.25"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_avgnumsumrhd_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">year</span>, names_from <span class="op">=</span> <span class="va">scenario</span>, values_from <span class="op">=</span> <span class="va">avg_num_sumrhd</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["rcp45"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["rcp85"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"2070","2":"58.25","3":"66.50"},{"1":"2071","2":"56.75","3":"59.00"},{"1":"2072","2":"60.50","3":"62.25"},{"1":"2073","2":"65.00","3":"72.00"},{"1":"2074","2":"63.50","3":"69.25"},{"1":"2075","2":"59.75","3":"55.25"},{"1":"2076","2":"56.50","3":"70.00"},{"1":"2077","2":"54.00","3":"70.00"},{"1":"2078","2":"59.00","3":"72.50"},{"1":"2079","2":"59.75","3":"74.25"},{"1":"2080","2":"57.50","3":"63.25"},{"1":"2081","2":"66.50","3":"65.75"},{"1":"2082","2":"46.25","3":"65.75"},{"1":"2083","2":"60.75","3":"70.75"},{"1":"2084","2":"55.00","3":"71.50"},{"1":"2085","2":"59.75","3":"77.25"},{"1":"2086","2":"65.75","3":"73.00"},{"1":"2087","2":"55.50","3":"72.75"},{"1":"2088","2":"61.00","3":"76.00"},{"1":"2089","2":"52.75","3":"69.00"},{"1":"2090","2":"50.00","3":"75.75"},{"1":"2091","2":"63.00","3":"75.25"},{"1":"2092","2":"68.00","3":"76.25"},{"1":"2093","2":"64.50","3":"77.00"},{"1":"2094","2":"58.25","3":"79.50"},{"1":"2095","2":"67.50","3":"75.50"},{"1":"2096","2":"59.00","3":"77.75"},{"1":"2097","2":"58.25","3":"73.25"},{"1":"2098","2":"64.75","3":"80.25"},{"1":"2099","2":"56.50","3":"78.00"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p><br></p>
</section><section id="counting-consecutive-events" class="level2" data-number="1.11"><h2 data-number="1.11" class="anchored" data-anchor-id="counting-consecutive-events">
<span class="header-section-number">1.11</span> Counting Consecutive Events</h2>
<p>“Heat spells”, “cold spells”, and “extreme precipitation” events are all defined as consecutive days of a threshold event. The number of consecutive days may vary, but the general technique for identifying ‘spells’ is</p>
<ol type="1">
<li><p>Run an expression that tests whether the threshhold was passed for each day, returning a series TRUE or FALSE values.</p></li>
<li><p>Pass the TRUE / FALSE values into the rle(), which identifies ‘runs’ of TRUE and FALSE values</p></li>
<li><p>Count the number of runs that meet the minimum duration</p></li>
</ol>
<p>To illustrate this, take the following series of 30 temperature values. We’ll compute the number of heat spells where the temperature was 100 or more for three or more days in a row:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">96</span>,<span class="fl">97</span>,<span class="fl">101</span>,<span class="fl">98</span>,<span class="fl">100</span>,<span class="fl">102</span>,<span class="fl">101</span>,<span class="fl">99</span>,<span class="fl">94</span>,<span class="fl">89</span>,<span class="fl">97</span>,<span class="fl">102</span>,<span class="fl">104</span>,<span class="fl">101</span>,<span class="fl">103</span>,<span class="fl">99</span>,<span class="fl">92</span>,<span class="fl">94</span>,<span class="fl">88</span>,<span class="fl">90</span>,<span class="fl">98</span>,<span class="fl">101</span>,<span class="fl">99</span>,<span class="fl">103</span>,<span class="fl">104</span>,<span class="fl">102</span>,<span class="fl">98</span>,<span class="fl">97</span>,<span class="fl">98</span>,<span class="fl">99</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Step 1 is to check to see if each value exceeds the threshold):</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x_hot</span> <span class="op">&lt;-</span> <span class="va">x_temp</span> <span class="op">&gt;=</span> <span class="fl">100</span></span>
<span><span class="va">x_hot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE  TRUE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE  TRUE
[13]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE  TRUE
[25]  TRUE  TRUE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
<p>Next, feed the 30 TRUE/FALSE values into <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> (run-length encoding):</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rle_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">x_hot</span><span class="op">)</span></span>
<span><span class="va">rle_lst</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Run Length Encoding
  lengths: int [1:11] 2 1 1 3 4 4 6 1 1 3 ...
  values : logi [1:11] FALSE TRUE FALSE TRUE FALSE TRUE ...</code></pre>
</div>
</div>
<p><code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> returns a list with two elements. Both elements are vectors of the same length. The <code>lengths</code> element contains the number of contiguous identical elements found in a ‘run’ in the original data. The <code>values</code> element contains the corresponding value of the run (in this case TRUE/FALSE values. Using this info, we can see our original data started with two FALSE values, followed by one TRUE value, followed by one FALSE value, followed by three TRUE values, and so on.</p>
<p>To count the number of ‘TRUE’ runs (aka spells) equal to or longer than <em>n</em> days, we can apply a simple expression:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rle_lst</span><span class="op">$</span><span class="va">values</span> <span class="op">&amp;</span> <span class="va">rle_lst</span><span class="op">$</span><span class="va">lengths</span> <span class="op">&gt;=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
</div>
<p><br></p>
<p>Using these techniques, below we compute the number of heat spells where the temperature was 100 °F or more for three or more days in a row:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_sumrhd_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">cvar</span> <span class="op">==</span> <span class="st">"tasmax"</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hd <span class="op">=</span> <span class="va">temp_f</span> <span class="op">&gt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="fl">38</span>, <span class="va">degC</span><span class="op">)</span>,</span>
<span>         year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">year</span>, <span class="va">cvar</span>, <span class="va">scenario</span>, <span class="va">gcm</span>, <span class="va">temp_f</span>, <span class="va">hd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_sumrhd_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["dt"],"name":[1],"type":["date"],"align":["right"]},{"label":["year"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["cvar"],"name":[3],"type":["fct"],"align":["left"]},{"label":["scenario"],"name":[4],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[5],"type":["fct"],"align":["left"]},{"label":["temp_f"],"name":[6],"type":["units"],"align":["right"]},{"label":["hd"],"name":[7],"type":["lgl"],"align":["right"]}],"data":[{"1":"2070-06-01","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"79.84528 [degF]","7":"FALSE"},{"1":"2070-06-02","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"77.66851 [degF]","7":"FALSE"},{"1":"2070-06-03","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"74.73021 [degF]","7":"FALSE"},{"1":"2070-06-04","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"80.59488 [degF]","7":"FALSE"},{"1":"2070-06-05","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"86.26778 [degF]","7":"FALSE"},{"1":"2070-06-06","2":"2070","3":"tasmax","4":"rcp45","5":"HadGEM2-ES","6":"92.90264 [degF]","7":"FALSE"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We have to be a little creative to apply <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> in a data frame that has many time series in it (e.g., multiple years, GCMs, and emission scenarios). Each of the series needs to be fed into <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code> individually, and the list returned by rle() will have different lengths. But what we can do is set up a list structure to store the results of <code><a href="https://rdrr.io/r/base/rle.html">rle()</a></code>.</p>
<p>First, we create a grouped tibble. A group tibble is still a tibble, but also has groups of rows invisibly defined. As we shall see shortly, other functions know what to do with those groups.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_grps_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_sumrhd_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">scenario</span>, <span class="va">gcm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">bkrfld_grps_tbl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 22,080
Columns: 7
Groups: year, scenario, gcm [240]
$ dt       &lt;date&gt; 2070-06-01, 2070-06-01, 2070-06-01, 2070-06-01, 2070-06-01, …
$ year     &lt;dbl&gt; 2070, 2070, 2070, 2070, 2070, 2070, 2070, 2070, 2070, 2070, 2…
$ cvar     &lt;fct&gt; tasmax, tasmax, tasmax, tasmax, tasmax, tasmax, tasmax, tasma…
$ scenario &lt;fct&gt; rcp45, rcp45, rcp45, rcp45, rcp85, rcp85, rcp85, rcp85, rcp45…
$ gcm      &lt;fct&gt; HadGEM2-ES, CNRM-CM5, CanESM2, MIROC5, HadGEM2-ES, CNRM-CM5, …
$ temp_f   [degF] 79.84528 [degF], 106.15573 [degF], 90.13398 [degF], 95.24855…
$ hd       &lt;lgl&gt; FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, …</code></pre>
</div>
</div>
<p><br></p>
<p>Next, we have to write a function that we can feed into <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code>. If you read the documentation for group_modify(), it says the first two arguments of the function should accept i) a group of rows (as a tibble), ii) the properties of the group (e.g., which year, scenario, and gcm) as a 1-row tibble. our function should also return a tibble, that will be stacked for all the groups. In addition, <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code> will also automatically include columns for the grouping variables.</p>
<p>In our case, all we need is the number of heatspells so the function only has to return a 1x1 tibble.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">num_heatspells</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_tbl</span>, <span class="va">key_tbl</span>, <span class="va">num_days</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Feed the hd column into rle()</span></span>
<span>  <span class="va">rle_lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="va">data_tbl</span><span class="op">$</span><span class="va">hd</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Return a tibble with one row</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>num_spells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rle_lst</span><span class="op">$</span><span class="va">values</span> <span class="op">&amp;</span> <span class="va">rle_lst</span><span class="op">$</span><span class="va">lengths</span> <span class="op">&gt;=</span> <span class="va">num_days</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Now we can apply this function to every group:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numspells_tbl</span> <span class="op">&lt;-</span> <span class="va">bkrfld_grps_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="va">num_heatspells</span>, num_days <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bkrfld_numspells_tbl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["scenario"],"name":[2],"type":["fct"],"align":["left"]},{"label":["gcm"],"name":[3],"type":["fct"],"align":["left"]},{"label":["num_spells"],"name":[4],"type":["int"],"align":["right"]}],"data":[{"1":"2070","2":"rcp45","3":"CanESM2","4":"7"},{"1":"2070","2":"rcp45","3":"CNRM-CM5","4":"6"},{"1":"2070","2":"rcp45","3":"HadGEM2-ES","4":"5"},{"1":"2070","2":"rcp45","3":"MIROC5","4":"5"},{"1":"2070","2":"rcp85","3":"CanESM2","4":"3"},{"1":"2070","2":"rcp85","3":"CNRM-CM5","4":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Lastly, we can compute the average number of heatspells per emissions scenario:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bkrfld_numspells_tbl</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>avg_spells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">num_spells</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["scenario"],"name":[1],"type":["fct"],"align":["left"]},{"label":["avg_spells"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"rcp45","2":"4.791667"},{"1":"rcp85","2":"3.975000"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-parker_observed_2022" class="csl-entry" role="listitem">
Parker, Lauren E., Ning Zhang, John T. Abatzoglou, Steven M. Ostoja, and Tapan B. Pathak. 2022. <span>“Observed <span>Changes</span> in <span>Agroclimate</span> <span>Metrics</span> <span>Relevant</span> for <span>Specialty</span> <span>Crop</span> <span>Production</span> in <span>California</span>.”</span> <em>Agronomy</em> 12 (1): 205. <a href="https://doi.org/10.3390/agronomy12010205">https://doi.org/10.3390/agronomy12010205</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Preface">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./02_weather-data.html" class="pagination-link" aria-label="Weather Data">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Weather Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ucanr-igis/agroclimate-cookbook/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ucanr-igis/agroclimate-cookbook/edit/main/01_data-wrangling.qmd" class="toc-action"><i class="bi empty"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>